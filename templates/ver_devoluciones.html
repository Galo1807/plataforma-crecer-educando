{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h4>üîÅ Registro de Devoluciones - {{ cliente[1] }}</h4>

    <form method="POST" action="{{ url_for('agregar_devolucion', cliente_id=cliente[0]) }}">
        <table class="table table-bordered text-center">
            <thead>
                <tr>
                    <th>üìÖ Fecha</th>
                    {% for libro in libros %}
                        <th>{{ libro[1] }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <!-- Fila de precios -->
                <tr>
                    <td><strong>üí≤ Precio</strong></td>
                    {% for libro in libros %}
                        <td>${{ libro[2] }}</td>
                    {% endfor %}
                </tr>
                <!-- Fila de cantidades -->
                <tr>
                    <td><input type="text" name="nota" class="form-control" placeholder="Nota de devoluci√≥n"></td>
                    {% for libro in libros %}
                        <td>
                            <input type="hidden" name="materias[]" value="{{ libro[1] }}">
                            <input type="number" name="cantidades[]" class="form-control" min="0" value="0" required>
                        </td>
                    {% endfor %}
                </tr>
                <!-- Fila de fecha -->
                <tr>
                    <td colspan="{{ libros|length + 1 }}">
                        <input type="date" name="fecha" class="form-control" required>
                    </td>
                </tr>
            </tbody>
        </table>

        <button type="submit" class="btn btn-primary">‚ûï Agregar Nota</button>
        <a href="{{ url_for('ver_cliente', cliente_id=cliente[0]) }}" class="btn btn-secondary">üîô Volver</a>
    </form>

    <hr>

    <h5 class="mt-4">üìä Totales por Materia en el A√±o</h5>
    <table class="table table-striped text-center">
        <thead>
            <tr>
                <th>üìò Materia</th>
                <th>üîÅ Total Devuelto</th>
                <th>üí≤ Precio Unitario</th>
                <th>üí∞ Total USD</th>
            </tr>
        </thead>
        <tbody>
            {% for libro in libros %}
            <tr>
                <td>{{ libro[1] }}</td>
                <td>{{ totales[libro[1]].cantidad }}</td>
                <td>${{ libro[2] }}</td>
                <td>${{ "%.2f"|format(totales[libro[1]].cantidad * libro[2]) }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="table-success">
                <th colspan="3">TOTAL GENERAL</th>
                <th>${{ "%.2f"|format(total_general) }}</th>
            </tr>
        </tfoot>
    </table>

    <hr>

    <h5 class="mt-4">üìÑ Detalle por Nota de Devoluci√≥n</h5>
    <table class="table table-hover text-center">
        <thead class="table-light">
            <tr>
                <th>üßæ Nota</th>
                <th>üìÖ Fecha</th>
                {% for libro in libros %}
                    <th>{{ libro[1] }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for nota, grupo in detalle_notas.items() %}
            <tr>
                <td>
                    {{ nota or 'Sin Nota' }}
                    <form method="POST" action="{{ url_for('eliminar_nota_devolucion', cliente_id=cliente[0]) }}" style="display:inline;">
                        <input type="hidden" name="nota" value="{{ nota }}">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('¬øEliminar esta nota?')">üóëÔ∏è</button>
                    </form>
                </td>
                <td>{{ grupo.fecha }}</td>
                {% for libro in libros %}
                    <td>{{ grupo.get(libro[1], 0) }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
